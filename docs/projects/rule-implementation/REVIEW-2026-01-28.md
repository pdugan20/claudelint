# Rule Implementation Review - 2026-01-28

## Executive Summary

This review assesses the current state of rule documentation and enforcement checks for the claudelint project. While robust validation infrastructure exists, there are several documentation issues that need to be addressed.

## Current State

### Rules Overview

- **Registered Rule IDs**: 46 rules defined in `src/rules/rule-ids.ts`
- **Documented Rules**: 27 rule documentation files in `docs/rules/`
- **Implemented Rules**: 1 rule with actual code implementation
- **Orphaned Rules**: 41 rules registered but not yet implemented
- **Documentation Coverage**: 59% (27/46 rules have documentation)

### Rule Distribution by Validator

- **CLAUDE.md**: 8 rules (4 documented)
- **Skills**: 13 rules (11 documented)
- **Agents**: 2 rules (0 documented)
- **Settings**: 4 rules (3 documented)
- **Hooks**: 3 rules (3 documented)
- **MCP**: 3 rules (3 documented)
- **Plugin**: 5 rules (3 documented)
- **Commands**: 3 rules (0 documented)
- **LSP**: 0 rules (0 documented)
- **Output Styles**: 0 rules (0 documented)

## Validation Infrastructure

### Existing Checks (Working)

1. **`check:rule-docs`** - Documentation structure validation
   - Validates H1 title format: `# Rule: rule-id`
   - Checks for required sections
   - Validates metadata fields and values
   - Checks for code blocks without language identifiers
   - Warns about missing code examples

2. **`check:rule-ids`** - Rule ID registration validation
   - Verifies all rule IDs are registered in `rule-ids.ts`
   - Detects orphaned rule IDs (registered but not used)
   - Validates no duplicate rule IDs exist

3. **`check:consistency`** - Code/documentation consistency
   - Validates severity matches between code and docs
   - Verifies filename matches rule ID
   - Checks validator name consistency

4. **`check:rule-coverage`** - Test coverage validation
   - Checks which rules have tests
   - Validates coverage meets threshold

5. **`check:all`** - Runs all validation checks

### Documentation Requirements

According to `docs/rule-development-enforcement.md`, each rule document must have:

1. **Title** (H1) - Format: `# Rule: {rule-id}`
2. **Summary** - One-sentence description
3. **Rule Details** (H2) - Detailed explanation with examples
4. **Options** (H2) - Configuration options
5. **When Not To Use It** (H2) - Guidance on when to disable
6. **Related Rules** (H2) - Links to related rules
7. **Version** (H2) - Availability info
8. **Metadata** (H2) - Category, Severity, Fixable, Validator

### Metadata Requirements

```markdown
## Metadata

- **Category**: {Schema Validation, Cross-Reference, File System, etc.}
- **Severity**: {error|warning}
- **Fixable**: {Yes|No}
- **Validator**: {CLAUDE.md|Skills|Agents|Settings|Hooks|MCP|Plugin|Commands|LSP|Output Styles}
```

## Issues Found

### Critical Issues (Block Commit)

1. **`docs/rules/claude-md/size-error.md`** - Completely broken
   - Missing H1 title
   - Missing "Rule Details" section
   - Missing "Options" section
   - Missing "When Not To Use It" section
   - Missing "Version" section
   - Only contains Metadata section

2. **`docs/rules/skills/skill-deep-nesting.md`** - Structural issues
   - Wrong title format: `# Deep Nesting` instead of `# Rule: skill-deep-nesting`
   - Missing entire "Metadata" section
   - Version info in wrong location

3. **`docs/rules/skills/skill-missing-shebang.md`** - Section ordering issue
   - "Version" section appears AFTER "Metadata" section
   - Should be: Version → Metadata (not Metadata → Version content)

### Warnings (Non-blocking)

4. **Missing Code Examples** - 42 documentation files
   - The `check:rule-docs` script looks for examples containing the words "incorrect" and "correct"
   - Many docs use headings like "### Violation Example" or "### Correct Examples" instead
   - The script pattern matching may be too strict

   Affected files:
   - All CLAUDE.md rule docs (4 files)
   - All hooks rule docs (3 files)
   - All MCP rule docs (3 files)
   - All plugin rule docs (3 files)
   - All settings rule docs (3 files)
   - Many skills rule docs

### Analysis: Code Examples Issue

Looking at the validation script (lines 153-157 in `check-rule-docs.ts`):

```typescript
// Check for examples
if (line.includes('incorrect') || line.includes('correct')) {
  if (line.toLowerCase().includes('example')) {
    hasExamples = true;
  }
}
```

The script requires:
1. A line containing "incorrect" OR "correct"
2. The same line must also contain "example"

However, many docs use patterns like:
- `### Violation Example` (has "example" but not "incorrect")
- `### Correct Examples` (has both "correct" and "example") ✓
- `Examples of **incorrect** code` (has both "incorrect" and "example") ✓

## Specific File Issues

### `docs/rules/claude-md/size-error.md`

**Current content:**
```markdown

## Metadata

- **Category**: Best Practices
- **Severity**: error
- **Fixable**: No
- **Validator**: CLAUDE.md

```

**Needs:**
- Full rewrite following TEMPLATE.md
- Title, description, rule details, examples, all sections

### `docs/rules/skills/skill-deep-nesting.md`

**Issues:**
1. Line 1: Should be `# Rule: skill-deep-nesting` not `# Deep Nesting`
2. Missing Metadata section at the end
3. Lines 19-22 have metadata but wrong format (missing markdown heading)
4. Multiple unclosed code blocks (lines 17, 38, 58, 71, 88, 104, 119, 128, 137, 146, 156, 175, 191, 202, 220, 233, 245, 270, 280)

### Other Files with Minor Issues

Most other rule documentation files are well-structured but fail the "incorrect/correct example" check due to using alternative wording like:
- "Violation Example" instead of "incorrect"
- "Correct Example" (singular) instead of "Examples of **correct** code"

## Validation Script Issues

### `check-rule-docs.ts` - Example Detection Too Strict

The current example detection logic (lines 153-157) requires BOTH "example" AND ("incorrect" OR "correct") on the SAME line. This fails to detect valid examples that use:

- `### Violation Example` (clear intent, but missing "incorrect" keyword)
- Section headers followed by example code blocks

**Recommendation**: Update the logic to be more flexible:
- Accept "violation" as equivalent to "incorrect"
- Accept section headers that indicate examples
- Look for example patterns across multiple lines

## Recommendations

### Immediate Actions (Priority 1)

1. **Fix Critical Documentation Issues**
   - Rewrite `docs/rules/claude-md/size-error.md` from scratch using TEMPLATE.md
   - Fix `docs/rules/skills/skill-deep-nesting.md`:
     - Change title to proper format
     - Add Metadata section at the end
     - Fix unclosed code blocks
   - Fix `docs/rules/skills/skill-missing-shebang.md` section ordering

2. **Update Example Detection Logic**
   - Modify `check-rule-docs.ts` to accept "violation" as equivalent to "incorrect"
   - Make the example detection more flexible
   - Consider multi-line pattern matching

### Short-term Actions (Priority 2)

3. **Standardize Example Headings**
   - Choose one standard: either TEMPLATE.md format or the alternative format
   - Update either the template or the existing docs to match
   - Update validation script to match the chosen standard

   **Option A**: Update template to allow "Violation Example" / "Correct Example"
   **Option B**: Update all docs to use "Examples of **incorrect** code" format
   **Recommendation**: Option A (less churn, already widely used)

4. **Document Outstanding Rules**
   - 41 rules are registered but not implemented
   - Consider if all 41 rules are still needed
   - Remove orphaned rule IDs that won't be implemented
   - Add documentation for rules that will be implemented

### Long-term Actions (Priority 3)

5. **Enhance Pre-commit Hooks**
   - Add `check:rule-docs` to pre-commit hooks
   - This will prevent broken documentation from being committed

6. **Create Documentation Guideline**
   - Create a "common mistakes" guide based on this review
   - Add examples of correct and incorrect documentation
   - Include guidance on example wording

7. **Consider Auto-generation**
   - Implement rule documentation scaffolding tool
   - Auto-generate skeleton docs from rule ID registration
   - Pre-fill metadata from code where possible

## Next Steps

### Step 1: Fix Broken Documentation (Now)

Fix the 3 files with critical issues:
1. `size-error.md` - Complete rewrite
2. `skill-deep-nesting.md` - Fix title, metadata, code blocks
3. `skill-missing-shebang.md` - Fix section order

### Step 2: Update Validation Script (Now)

Update `check-rule-docs.ts` to accept "violation" as equivalent to "incorrect":

```typescript
// Check for examples
const hasIncorrectExample = line.includes('incorrect') ||
                           line.toLowerCase().includes('violation');
const hasCorrectExample = line.includes('correct');
const hasExampleKeyword = line.toLowerCase().includes('example');

if (hasExampleKeyword && (hasIncorrectExample || hasCorrectExample)) {
  hasExamples = true;
}
```

### Step 3: Decide on Standard (Soon)

Decide whether to:
- **Option A**: Update template and validation to accept both formats
- **Option B**: Update all docs to strictly follow current template

### Step 4: Document Remaining Rules (Later)

- Review the 41 orphaned rule IDs
- Decide which rules to implement
- Remove rule IDs that won't be implemented
- Create documentation for rules that will be implemented

## Conclusion

The validation infrastructure is well-designed and comprehensive. The main issues are:

1. **3 files with broken documentation** (critical, fix now)
2. **42 files with example wording that doesn't match validation script** (warning, decide on standard)
3. **41 orphaned rule IDs** (not blocking, prioritize which to implement)

Once the broken documentation files are fixed and the validation script is updated to be more flexible, the project will have a solid foundation for rule documentation and enforcement.

## Files Requiring Attention

### Must Fix Now
- `docs/rules/claude-md/size-error.md` - Complete rewrite
- `docs/rules/skills/skill-deep-nesting.md` - Fix structure
- `docs/rules/skills/skill-missing-shebang.md` - Fix section order
- `scripts/check-rule-docs.ts` - Update example detection

### Review and Decide
- All 42 files with "missing examples" warning - Decide on standard
- `src/rules/rule-ids.ts` - Review orphaned rule IDs
